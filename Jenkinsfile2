pipeline {
    agent {
        kubernetes {
            label 'jenkins-slave-pipeline-2'
            defaultContainer 'maven' // Changed default container to 'maven'
            yaml '''
            apiVersion: v1
            kind: Pod
            spec:
              containers:
              - name: maven
                image: maven:alpine
                command:
                - cat
                tty: true
            '''
        }
    }

    environment {
        DOCKER_IMAGE = "roiyki/persudoku-flask"
        DOCKERHUB_CREDENTIALS = 'docker-credentials' // Define Docker Hub credentials
        DOCKERHUB_REGISTRY = 'https://hub.docker.com/roiyki/'
    }

    stages {
        stage('Run on Node') {
            steps {
                node {
                    stage('Checkout Code') {
                        steps {
                            checkout scm
                        }
                    }

                    stage('Build Docker Image') {
                        steps {
                            script {
                                docker.withRegistry("$DOCKERHUB_REGISTRY", "$DOCKERHUB_CREDENTIALS") {
                                    def testImage = docker.build("${DOCKER_IMAGE}:latest", "-f Dockerfile .app/backend")
                                    testImage.push('latest')
                                }
                            }
                        }
                    }
                }
            }
        }
    }

    post {
        always {
            echo 'Pipeline completed.'
        }
        success {
            echo 'Pipeline succeeded.'
        }
        failure {
            echo 'Pipeline failed.'
        }
    }
}
